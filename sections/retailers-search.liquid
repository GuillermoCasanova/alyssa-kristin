{{ 'section-retailers-search.css' | asset_url | stylesheet_tag }}
<section class="retailers-search" id="retailers-search">
  <div class="retailers-search__inner page-width is-small">
    <div class="retailers-search__heading">
      <h2>{{ section.settings.heading }}</h2>
    </div>
    <div class="retailers-search__body">
      {{ section.settings.body }}
    </div>
    <div class="retailers-search__form">
      <form action="/search" method="get">
        <input
          type="text"
          name="q"
          placeholder="{{ section.settings.search_placeholder }}"
          class="retailers-search__input"
        >
        <button type="submit" class="retailers-search__button">{{ section.settings.search_button_text }}</button>
      </form>
    </div>
    <div id="map" class="retailers-search__map"></div>
  </div>
</section>

<script>
  async function initMap() {
    // Initialize the map
    const map = new google.maps.Map(document.getElementById('map'), {
      mapId: 'd4c46217781fbc79',
      center: { lat: 18.2208, lng: -66.5901 },
      zoom: 6,
    });

    // Import the 'marker' library for AdvancedMarkerElement
    const { AdvancedMarkerElement } = await google.maps.importLibrary('marker');

    // Load JSON data from the script tag
    const locationDataScript = document.getElementById('location-data').innerHTML;
    addMarkersFromJson(locationDataScript, map, AdvancedMarkerElement);
  }

  function addMarkersFromJson(jsonArray, map, AdvancedMarkerElement) {
    const locations = JSON.parse(jsonArray).locations;

    locations.forEach((location) => {
      // Create a new AdvancedMarkerElement for each location
      const marker = new AdvancedMarkerElement({
        position: new google.maps.LatLng(location.lat, location.lng),
        map: map,
        title: location.store_info.name,
      });

      // Define the content for the InfoWindow
      const infoWindowContent = `
        <div>
          <strong>${location.store_info.name}</strong><br>
          ${location.store_info.address}<br>
          ${location.store_info.state}, ${location.store_info.country}<br>
          ${location.store_info.phone}
        </div>
      `;

      // Create an InfoWindow instance
      const infoWindow = new google.maps.InfoWindow({
        content: infoWindowContent,
      });

      // Add a listener to open the InfoWindow when the marker is clicked
      marker.addListener('gmp-click', () => {
        infoWindow.open({
          anchor: marker,
          map: map,
          shouldFocus: false,
        });
      });
    });
  }
</script>

<script type="text/template" id="location-data">
  {
    "locations":    [
      {% for block in section.blocks %}
        {
        "lat": {{ block.settings.latitude }},
        "lng": {{ block.settings.longitude }},
        "store_info": {
          "name": "{{ block.settings.store_name }}",
          "address": "{{ block.settings.address }}",
          "country": "{{ block.settings.country }}",
          "state": "{{ block.settings.state }}",
          "phone": "{{ block.settings.phone_number }}"
        }
      }{% if forloop.last == false %},{% endif %}
    {% endfor %}
  ]
  }
</script>

<script
  src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDKHxrK3dLtjFWFyldmazZOaRl9gtRwuwg&callback=initMap"
  defer
  async
></script>

{% schema %}
{
  "name": "Retailers Search",
  "enabled_on": {
    "templates": ["page"]
  },
  "settings": [
    {
      "type": "header",
      "content": "Content"
    },
    {
      "id": "heading",
      "type": "text",
      "label": "Heading",
      "default": "Find a Retailer"
    },
    {
      "id": "body",
      "type": "richtext",
      "label": "Body Copy",
      "default": "<p>Use the search below to find a retailer near you.</p>"
    },
    {
      "id": "search_placeholder",
      "type": "text",
      "label": "Search Placeholder",
      "default": "Enter your city or zip code"
    },
    {
      "id": "search_button_text",
      "type": "text",
      "label": "Search Button Text",
      "default": "Search"
    }
  ],
  "blocks": [
    {
      "type": "location",
      "name": "Location",
      "settings": [
        {
          "id": "store_name",
          "type": "text",
          "label": "Store Name"
        },
        {
          "id": "website",
          "type": "url",
          "label": "Website"
        },
        {
          "id": "phone_number",
          "type": "text",
          "label": "Phone Number"
        },
        {
          "id": "address",
          "type": "richtext",
          "label": "Address"
        },
        {
          "id": "state",
          "type": "text",
          "label": "State"
        },
        {
          "id": "country",
          "type": "text",
          "label": "Country"
        },
        {
          "id": "longitude",
          "type": "number",
          "label": "Longitude"
        },
        {
          "id": "latitude",
          "type": "number",
          "label": "Latitude"
        },
        {
          "id": "gown",
          "type": "checkbox",
          "label": "Gown"
        },
        {
          "id": "lwd",
          "type": "checkbox",
          "label": "LWD"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Default",
      "category": "Search",
      "settings": {
        "heading": "Find a Retailer",
        "body": "<p>Use the search below to find a retailer near you.</p>",
        "search_placeholder": "Enter your city or zip code",
        "search_button_text": "Search"
      }
    }
  ]
}
{% endschema %}
